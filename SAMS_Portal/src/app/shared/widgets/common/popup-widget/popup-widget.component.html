<div class="enhanced-popup-container" [@fadeInOut] [ngClass]="{
  'form-type': isFormType,
  'view-type': isViewType,
  'confirm-type': isConfirmType,
  'compact-mode': isCompactMode,
  'two-column': isFormType() && formConfig?.columns === 2,
  'one-column': isFormType() && formConfig?.columns === 1
}">
  
  <!-- ==================== FORM POPUP ==================== -->
  <ng-container *ngIf="isFormType">
    <ng-container *ngIf="formConfig as config">
      <div *ngIf="form" class="form-popup">

        <!-- Header -->
        <div class="popup-header" [@slideInOut]>
          <div class="header-content">
            <div class="header-icon-title">
              <div class="user-avatar-section" *ngIf="config.title.includes('User')">
                <img [src]="getUserProfileImage()" 
                     [alt]="getUserFullName()" 
                     class="header-user-avatar"
                     loading="lazy">
              </div>
              
              <mat-icon *ngIf="config.icon && !config.title.includes('User')" class="header-icon icon-primary">
                {{ config.icon }}
              </mat-icon>
              
              <div class="title-section">
                <h2 class="popup-title">{{ config.title }}</h2>
                <p *ngIf="config.subtitle" class="popup-subtitle">{{ config.subtitle }}</p>
              </div>
            </div>
            <button *ngIf="config.showCloseButton !== false"
                    mat-icon-button class="close-button"
                    (click)="onClose()"
                    [disabled]="loading()"
                    matTooltip="Close">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- Form Content -->
        <div class="popup-content" [@slideInOut]>
          <form [formGroup]="form" (ngSubmit)="onSubmit()" class="popup-form">
            
            <!-- Profile Image Upload (User-specific) -->
            <div class="profile-image-section" *ngIf="config.title.includes('User')">
              <div class="image-upload-container">
                <div class="current-image">
                  <img [src]="getUserProfileImage()" 
                       [alt]="getUserFullName()" 
                       class="profile-preview"
                       loading="lazy">
                  <div class="image-overlay">
                    <button type="button" mat-icon-button 
                            class="upload-btn"
                            (click)="openFileChooser(fileInput)"
                            [disabled]="imageUploading()"
                            matTooltip="Change Photo">
                      <mat-spinner *ngIf="imageUploading()" diameter="20"></mat-spinner>
                      <mat-icon *ngIf="!imageUploading()">photo_camera</mat-icon>
                    </button>
                    <button type="button" mat-icon-button 
                            class="remove-btn"
                            *ngIf="(imagePreview() !== '/assets/images/ProfilePic.png' || form.get('profilePicture')?.value) && getUserProfileImage() !== '/assets/images/ProfilePic.png' && !imageUploading()"
                            (click)="onImageRemove()"
                            matTooltip="Remove Photo">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
                
                <input #fileInput type="file" 
                       accept="image/*" 
                       (change)="onImageSelect($event, fileInput)"
                       style="display: none;">
                       
                <div class="upload-info">
                  <p class="upload-text">Click on camera to upload photo</p>
                  <p class="upload-hint">JPG, PNG, GIF up to 5MB</p>
                </div>
              </div>
            </div>

            <!-- Form Fields Grid -->
            <div class="form-grid" [ngClass]="{
              'grid-1-column': config.columns === 1,
              'grid-2-column': config.columns === 2,
              'grid-3-column': config.columns === 3,
              'grid-4-column': config.columns === 4,
              'compact': config.compactMode
            }">
              
              <ng-container *ngFor="let field of config.fields; trackBy: trackByField">
                <div class="field-wrapper" 
                     [ngClass]="{
                       'span-1': field.colSpan === 1 || !field.colSpan,
                       'span-2': field.colSpan === 2,
                       'span-3': field.colSpan === 3,
                       'span-4': field.colSpan === 4,
                       'break-after': field.breakAfter,
                       'has-email-verification': field.type === 'email' && field.showEmailVerification
                     }"
                     [@fadeInOut]
                     *ngIf="shouldShowField(field)">

                  <!-- TEXT -->
                  <mat-form-field *ngIf="field.type === 'text'" appearance="outline" class="form-field">
                    <mat-label>{{ field.label }}</mat-label>
                    <input matInput
                           [formControlName]="field.key"
                           type="text"
                           [placeholder]="field.placeholder || ''"
                           [attr.maxLength]="field.maxLength ?? null"
                           [matTooltip]="field.tooltip || ''"
                           [matTooltipDisabled]="!field.tooltip">
                    
                    <mat-icon *ngIf="field.icon" matPrefix class="field-icon">{{ field.icon }}</mat-icon>
                    <span *ngIf="field.prefix" matTextPrefix>{{ field.prefix }}</span>
                    <span *ngIf="field.suffix" matTextSuffix>{{ field.suffix }}</span>
                    
                    <mat-error *ngIf="isFieldInvalid(field.key)">{{ getFieldError(field.key) }}</mat-error>
                  </mat-form-field>

                  <!-- EMAIL WITH VERIFICATION TOGGLE -->
                  <ng-container *ngIf="field.type === 'email'">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ field.label }}</mat-label>
                      <input matInput
                             [formControlName]="field.key"
                             type="email"
                             [placeholder]="field.placeholder || ''"
                             [attr.maxLength]="field.maxLength ?? null"
                             [matTooltip]="isEmailFieldDisabled(field) ? getDisabledEmailTooltip(field) : (field.tooltip || '')"
                             [matTooltipDisabled]="!isEmailFieldDisabled(field) && !field.tooltip">

                      <mat-icon *ngIf="field.icon" matPrefix class="field-icon">{{ field.icon }}</mat-icon>

                      <!-- ðŸ†• Show verified icon in email field if already verified -->
                      <mat-icon *ngIf="isEmailAlreadyVerified(field)" 
                                matSuffix 
                                class="verified-suffix-icon"
                                matTooltip="Email verified">
                        verified
                      </mat-icon>
                      <mat-icon *ngIf="!isEmailAlreadyVerified(field) && !field.icon" matSuffix>email</mat-icon>

                      <mat-error *ngIf="isFieldInvalid(field.key)">{{ getFieldError(field.key) }}</mat-error>

                      <!-- ðŸ†• Show hint for verification requirement -->
                      <!-- <mat-hint *ngIf="!isEmailAlreadyVerified(field)">
                        Enter a valid email to enable verification option
                      </mat-hint> -->
                    </mat-form-field>
                  
                    <!-- ðŸ”¥ UPDATED: Email Verification Toggle -->
                    <div *ngIf="field.showEmailVerification && getEmailVerificationControl(field) as verifyControl" 
                         class="email-verification-toggle"
                         [class.verified-disabled]="isEmailAlreadyVerified(field)"
                         [class.toggle-disabled]="isEmailVerificationDisabled(field) && !isEmailAlreadyVerified(field)">

                      <mat-slide-toggle [formControl]="verifyControl"
                                        color="primary"
                                        class="verification-toggle">
                        <span class="toggle-label">
                          {{ field.emailVerificationLabel || 'Send Verification Email' }}
                        </span>
                      </mat-slide-toggle>

                      <!-- ðŸ”¥ UPDATED: Show "Verified" badge ONLY when backend confirmed -->
                      <div *ngIf="isEmailAlreadyVerified(field)" class="verification-status-badge">
                        <mat-icon class="verified-icon">verified</mat-icon>
                        <span class="verified-text">Verified</span>
                      </div>

                      <!-- ðŸ†• Show "Invalid Email" message when toggle is disabled due to invalid email -->
                      <div *ngIf="!isEmailAlreadyVerified(field) && isEmailVerificationDisabled(field)" 
                           class="verification-disabled-hint">
                        <mat-icon class="hint-icon">info_outline</mat-icon>
                        <span class="hint-text">Enter valid email first</span>
                      </div>

                      <!-- Info button (only show when NOT verified) -->
                      <button type="button" 
                              *ngIf="!isEmailAlreadyVerified(field) && !isEmailVerificationDisabled(field)"
                              mat-icon-button 
                              class="info-button"
                              [matTooltip]="getEmailVerificationTooltip(field)"
                              matTooltipPosition="right"
                              matTooltipClass="verification-tooltip">
                        <mat-icon class="info-icon">info</mat-icon>
                      </button>
                    </div>
                  </ng-container>

                  <!-- PASSWORD -->
                  <mat-form-field *ngIf="field.type === 'password'" appearance="outline" class="form-field">
                    <mat-label>{{ field.label }}</mat-label>
                    <input matInput
                           [formControlName]="field.key"
                           type="password"
                           [placeholder]="field.placeholder || ''"
                           [attr.maxLength]="field.maxLength ?? null"
                           [matTooltip]="field.tooltip || ''"
                           [matTooltipDisabled]="!field.tooltip">
                    
                    <mat-icon *ngIf="field.icon" matPrefix class="field-icon">{{ field.icon }}</mat-icon>
                    <mat-icon *ngIf="!field.icon" matSuffix>lock</mat-icon>
                    
                    <mat-error *ngIf="isFieldInvalid(field.key)">{{ getFieldError(field.key) }}</mat-error>
                  </mat-form-field>

                  <!-- NUMBER -->
                  <mat-form-field *ngIf="field.type === 'number'" appearance="outline" class="form-field">
                    <mat-label>{{ field.label }}</mat-label>
                    <input matInput
                           type="number"
                           [formControlName]="field.key"
                           [placeholder]="field.placeholder || ''"
                           [min]="field.min ?? null"
                           [max]="field.max ?? null"
                           [matTooltip]="field.tooltip || ''"
                           [matTooltipDisabled]="!field.tooltip">
                    
                    <mat-icon *ngIf="field.icon" matPrefix class="field-icon">{{ field.icon }}</mat-icon>
                    <span *ngIf="field.prefix" matTextPrefix>{{ field.prefix }}</span>
                    <span *ngIf="field.suffix" matTextSuffix>{{ field.suffix }}</span>
                    
                    <mat-error *ngIf="isFieldInvalid(field.key)">{{ getFieldError(field.key) }}</mat-error>
                  </mat-form-field>

                  <!-- TEXTAREA -->
                  <mat-form-field *ngIf="field.type === 'textarea'" appearance="outline" class="form-field textarea-field">
                    <mat-label>{{ field.label }}</mat-label>
                    <textarea matInput
                              [formControlName]="field.key"
                              [placeholder]="field.placeholder || ''"
                              [rows]="field.rows || 3"
                              [attr.maxLength]="field.maxLength ?? null"
                              [matTooltip]="field.tooltip || ''"
                              [matTooltipDisabled]="!field.tooltip"></textarea>
                    
                    <mat-icon *ngIf="field.icon" matPrefix class="field-icon">{{ field.icon }}</mat-icon>
                    
                    <mat-error *ngIf="isFieldInvalid(field.key)">{{ getFieldError(field.key) }}</mat-error>
                  </mat-form-field>

                  <!-- FILE UPLOAD -->
                  <div *ngIf="field.type === 'file'" class="file-field" [ngClass]="getFileFieldClasses(field)">
                  <div class="file-upload-container">
                    
                    <!-- Label Section -->
                    <div class="file-label-section">
                      <mat-icon class="file-icon">{{ field.icon || 'upload_file' }}</mat-icon>
                      <label class="file-label">{{ field.label }}</label>
                      <span *ngIf="field.required" class="required-indicator">*</span>
                    </div>
                    
                    <!-- Upload Area with Preview -->
                    <div class="file-upload-area" 
                           [class.has-file]="getFilePreview(field.key)"
                           [class.drag-over]="isFileDragOver(field.key)"
                           (dragover)="onFileDragOver($event, field.key)"
                           (dragleave)="onFileDragLeave($event, field.key)"
                           (drop)="onFileDrop($event, field.key)">

                        <!-- No File State -->
                        <div *ngIf="!getFilePreview(field.key)" class="upload-prompt">
                          <mat-icon class="upload-icon">cloud_upload</mat-icon>
                          <p class="upload-text">
                            Drag & drop or 
                            <button type="button" 
                                    mat-button 
                                    color="primary"
                                    class="browse-button"
                                    (click)="openFilePicker(field.key)">
                              Browse
                            </button>
                          </p>
                          <p *ngIf="field.helperText" class="upload-hint">{{ field.helperText }}</p>
                          <p *ngIf="!field.helperText && field.acceptedFileTypes" class="upload-hint">
                            Accepted: {{ field.acceptedFileTypes }}
                            <span *ngIf="field.maxFileSize"> (Max {{ field.maxFileSize }}MB)</span>
                          </p>
                        </div>
                      
                        <!-- File Preview State -->
                        <div *ngIf="getFilePreview(field.key)" class="file-preview">
                          <div class="preview-content">

                            <!-- Image Preview -->
                            <div *ngIf="isImageFile(getFieldFileUrl(field.key)!)" class="image-preview-wrapper">
                              <img [src]="getFieldFileUrl(field.key)" 
                                   alt="Preview"
                                   [style.width]="field.previewWidth || '100%'"
                                   [style.max-width]="isCompactFileField(field) ? '100%' : '400px'"
                                   [style.height]="field.previewHeight || 'auto'"
                                   [style.max-height]="isCompactFileField(field) ? '120px' : '300px'"
                                   class="image-preview">
                            </div>
                          
                            <!-- Document Preview -->
                            <div *ngIf="!isImageFile(getFieldFileUrl(field.key)!)" class="document-preview">
                              <div class="doc-icon-wrapper">
                                <mat-icon class="doc-icon">{{ getFileIcon(getFieldFileUrl(field.key)!) }}</mat-icon>
                              </div>
                              <div class="doc-details">
                                <span class="doc-name">{{ getFileName(getFieldFileUrl(field.key)!) }}</span>
                                <span class="doc-size" *ngIf="getFileObjectSize(field.key)">
                                  {{ getFileObjectSize(field.key) }}
                                </span>
                              </div>
                            </div>
                          </div>
                        
                          <!-- Action Buttons -->
                          <div class="file-actions">
                            <button type="button" 
                                    mat-icon-button 
                                    color="primary"
                                    class="change-file-btn"
                                    (click)="openFilePicker(field.key)"
                                    matTooltip="Change file">
                              <mat-icon>edit</mat-icon>
                            </button>
                            <button type="button" 
                                    mat-icon-button 
                                    color="warn"
                                    class="remove-file-btn"
                                    (click)="removeFile(field.key)"
                                    matTooltip="Remove file">
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        </div>
                      
                        <!-- Hidden File Input -->
                        <input type="file"
                               [id]="'file-input-' + field.key"
                               [accept]="field.acceptedFileTypes || '*'"
                               (change)="onFileSelected($event, field.key)"
                               style="display: none;">
                      </div>
                    
                      <!-- Error Message -->
                      <div *ngIf="isFieldInvalid(field.key)" class="file-error">
                        <mat-icon class="error-icon">error</mat-icon>
                        <span>{{ getFieldError(field.key) }}</span>
                      </div>
                    </div>
                  </div>

                  
                  <!-- SELECT with cascading support AND QUICK ADD -->
                  <div *ngIf="field.type === 'select'" class="select-field-wrapper">
                    <mat-form-field appearance="outline" class="form-field select-form-field">
                      <mat-label>{{ field.label }}</mat-label>

                      <mat-select [formControlName]="field.key"
                                  [matTooltip]="field.tooltip || ''"
                                  [matTooltipDisabled]="!field.tooltip"
                                  [placeholder]="field.placeholder || 'Select ' + field.label" >

                        <!-- Loading State -->
                        <mat-option *ngIf="isFieldLoading(field.key)" disabled>
                          <div class="loading-option">
                            <mat-spinner diameter="20"></mat-spinner>
                            <span>Loading options...</span>
                          </div>
                        </mat-option>

                        <!-- Country Options (Special Case) -->
                        <ng-container *ngIf="field.key === 'country' && countriesLoaded() && !isFieldLoading(field.key); else regularOptions">
                          <mat-option *ngFor="let country of countries()" 
                                      [value]="country.name"
                                      class="country-option">
                            <div class="country-option-content">
                              <img [src]="getCountryFlagUrl(country.code)" 
                                   [alt]="country.name + ' flag'"
                                   class="country-flag"
                                   loading="lazy"
                                   onerror="this.style.display='none'">
                              <span class="country-name">{{ country.name }}</span>
                              <span class="country-code">({{ country.code }})</span>
                            </div>
                          </mat-option>
                        </ng-container>

                        <!-- Regular Options -->
                        <ng-template #regularOptions>
                          <ng-container *ngIf="!isFieldLoading(field.key)">
                            <!-- ðŸ”¥ ENTERPRISE FIX: Always use getFieldOptions() as single source of truth -->
                            <mat-option *ngFor="let opt of getFieldOptions(field.key)" 
                                        [value]="opt.value" 
                                        [disabled]="opt.disabled"
                                        class="custom-option">
                              <div class="option-content">
                                <span class="option-label">{{ opt.label }}</span>
                              </div>
                            </mat-option>

                            <!-- Empty State for Cascading - Show when parent not selected -->
                            <mat-option *ngIf="field.cascadeFrom && getFieldOptions(field.key).length === 0" disabled>
                              <div class="empty-option">
                                <mat-icon class="empty-icon">info_outline</mat-icon>
                                <span>
                                  {{ field.placeholder || ('Select ' + (field.cascadeFrom || 'parent field') + ' first') }}
                                </span>
                              </div>
                            </mat-option>
                          </ng-container>
                        </ng-template>

                      </mat-select>

                      <!-- Prefix Icon -->
                      <mat-icon *ngIf="field.icon && !isFieldLoading(field.key)" matPrefix class="field-icon">
                        {{ field.icon }}
                      </mat-icon>

                      <!-- Loading Spinner -->
                      <mat-spinner *ngIf="isFieldLoading(field.key)" 
                                   matPrefix 
                                   diameter="20" 
                                   class="field-loading-spinner">
                      </mat-spinner>

                      <!-- Quick Add Button -->
                      <div *ngIf="field.quickAdd?.enabled && !isFieldLoading(field.key)" 
                           matSuffix
                           class="quick-add-wrapper">
                        <button type="button"
                                mat-icon-button 
                                class="quick-add-button"
                                [class.loading]="isQuickAddLoading(field.key)"
                                [class.success]="isQuickAddSuccess(field.key)"
                                [class.disabled]="isQuickAddDisabled(field)"
                                [matTooltip]="isQuickAddDisabled(field) ? getQuickAddDisabledTooltip(field) : (field.quickAdd?.buttonLabel || 'Add New ' + field.label)"
                                [disabled]="isQuickAddLoading(field.key) || isQuickAddDisabled(field)"
                                (click)="onQuickAddClick(field, $event)"
                                [@successPulse]="isQuickAddSuccess(field.key) ? 'success' : 'idle'">

                          <mat-spinner *ngIf="isQuickAddLoading(field.key)" 
                                       diameter="20"
                                       class="button-spinner"></mat-spinner>

                          <mat-icon *ngIf="isQuickAddSuccess(field.key)" class="success-icon">
                            check_circle
                          </mat-icon>
                        
                          <mat-icon *ngIf="!isQuickAddLoading(field.key) && !isQuickAddSuccess(field.key)" 
                                    class="add-icon"
                                    [class.disabled-icon]="isQuickAddDisabled(field)">
                            {{ field.quickAdd?.buttonIcon || 'add_circle_outline' }}
                          </mat-icon>
                        </button>
                      
                        <span class="quick-add-hint" 
                              [class.disabled-hint]="isQuickAddDisabled(field)">
                          Quick add
                        </span>
                      </div>

                      <mat-error *ngIf="isFieldInvalid(field.key)">
                        {{ getFieldError(field.key) }}
                      </mat-error>

                      <mat-hint *ngIf="field.cascadeFrom && form.get(field.cascadeFrom)?.disabled" class="cascade-hint">
                        <mat-icon class="hint-icon">arrow_upward</mat-icon>
                        Select {{ field.cascadeFrom }} first
                      </mat-hint>
                    </mat-form-field>

                    <div *ngIf="isQuickAddSuccess(field.key)" class="success-notification" [@fadeInOut]>
                      <mat-icon>check_circle</mat-icon>
                      <span>Added successfully!</span>
                    </div>
                  </div>

                  <!-- DATE -->
                  <mat-form-field *ngIf="field.type === 'date'" appearance="outline" class="form-field">
                    <mat-label>{{ field.label }}</mat-label>
                    <input matInput 
                           [matDatepicker]="picker" 
                           [formControlName]="field.key" 
                           [min]="field.min ?? null" 
                           [max]="field.max ?? null"
                           [matTooltip]="field.tooltip || ''"
                           [matTooltipDisabled]="!field.tooltip">
                    
                    <mat-icon *ngIf="field.icon" matPrefix class="field-icon">{{ field.icon }}</mat-icon>
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                    
                    <mat-error *ngIf="isFieldInvalid(field.key)">{{ getFieldError(field.key) }}</mat-error>
                  </mat-form-field>

                  <!-- CHECKBOX -->
                  <div *ngIf="field.type === 'checkbox'" class="checkbox-field">
                    <mat-checkbox [formControlName]="field.key"
                                  [matTooltip]="field.tooltip || ''"
                                  [matTooltipDisabled]="!field.tooltip">
                      {{ field.label }}
                    </mat-checkbox>
                    <div *ngIf="isFieldInvalid(field.key)" class="field-error">{{ getFieldError(field.key) }}</div>
                  </div>

                  <!-- RADIO -->
                  <div *ngIf="field.type === 'radio'" class="radio-field">
                    <label class="radio-label">{{ field.label }}</label>
                    <mat-radio-group [formControlName]="field.key" 
                                     class="radio-group"
                                     [matTooltip]="field.tooltip || ''"
                                     [matTooltipDisabled]="!field.tooltip">
                      <mat-radio-button *ngFor="let opt of field.options" 
                                        [value]="opt.value" 
                                        [disabled]="opt.disabled"
                                        class="radio-option">
                        {{ opt.label }}
                      </mat-radio-button>
                    </mat-radio-group>
                    <div *ngIf="isFieldInvalid(field.key)" class="field-error">{{ getFieldError(field.key) }}</div>
                  </div>

                  <!-- INFO FIELD -->
                  <div *ngIf="field.type === 'info'" class="info-field">
                    <mat-card class="info-card" [ngClass]="'info-' + (field.color || 'primary')">
                      <mat-card-content>
                        <div class="info-content">
                          <mat-icon *ngIf="field.icon" class="info-icon">{{ field.icon }}</mat-icon>
                          <div class="info-text">
                            <div class="info-label" *ngIf="field.label">{{ field.label }}</div>
                            <div class="info-value">{{ field.value }}</div>
                            <div class="info-helper" *ngIf="field.helperText">{{ field.helperText }}</div>
                          </div>
                        </div>
                      </mat-card-content>
                    </mat-card>
                  </div>

                  <!-- TOGGLE FIELD -->
                  <div *ngIf="field.type === 'toggle'" class="toggle-field">
                    <div class="toggle-wrapper">
                      <mat-slide-toggle 
                        [formControlName]="field.key"
                        [color]="field.color || 'primary'"
                        [matTooltip]="field.tooltip || ''"
                        [matTooltipDisabled]="!field.tooltip"
                        class="custom-toggle">
                        <span class="toggle-label-text">
                          <mat-icon *ngIf="field.icon" class="toggle-icon">{{ field.icon }}</mat-icon>
                          {{ field.label }}
                        </span>
                      </mat-slide-toggle>
                      
                      <div *ngIf="field.helperText" class="toggle-helper-text">
                        <mat-icon class="helper-icon">info_outline</mat-icon>
                        <span>{{ field.helperText }}</span>
                      </div>
                    </div>
                    
                    <div *ngIf="isFieldInvalid(field.key)" class="field-error">
                      {{ getFieldError(field.key) }}
                    </div>
                  </div>

                  <!-- DIVIDER FIELD -->
                  <div *ngIf="field.type === 'divider'" 
                       class="divider-field"
                       [class.view-divider]="isViewType()">
                    <mat-divider></mat-divider>
                    <span *ngIf="field.label" class="divider-label">{{ field.label }}</span>
                    <!-- <mat-divider></mat-divider> -->
                  </div>

                </div>
              </ng-container>
            </div>

            <!-- Form Actions -->
            <div class="popup-actions form-actions" [@slideInOut]>
              <button mat-button type="button" (click)="onCancel()" [disabled]="loading()">
                {{ config.cancelButtonText || 'Cancel' }}
              </button>

              <button mat-raised-button color="primary" type="submit"
                      [disabled]="loading() || (form && form.invalid && submitted())">
                <mat-spinner *ngIf="loading()" diameter="20" class="button-spinner"></mat-spinner>
                <span *ngIf="!loading()">{{ config.submitButtonText || 'Submit' }}</span>
              </button>
            </div>

          </form>
        </div>

      </div>
    </ng-container>
  </ng-container>

  <!-- VIEW TYPE POPUP -->
  <ng-container *ngIf="isViewType">
    <ng-container *ngIf="viewConfig as config">
      <div class="view-popup">

        <!-- Header -->
        <div class="popup-header view-header" [@slideInOut]>
          <div class="header-content">
            <div class="user-profile-header" *ngIf="config.title.includes('User')">
              <img [src]="getUserProfileImage()" 
                   [alt]="getUserFullName()" 
                   class="profile-avatar-large"
                   loading="lazy">
              <div class="user-info">
                <h2 class="user-name">{{ getUserFullName() }}</h2>
                <p class="user-subtitle">{{ config.subtitle }}</p>
                <div class="user-badges" *ngIf="data.data">
                  <mat-chip *ngIf="data.data.designationDisplay" class="designation-chip">
                    <mat-icon matChipAvatar>work</mat-icon>
                    {{ data.data.designationDisplay }}
                  </mat-chip>
                  <mat-chip *ngIf="data.data.departmentDisplay" class="department-chip">
                    <mat-icon matChipAvatar>business</mat-icon>
                    {{ data.data.departmentDisplay }}
                  </mat-chip>
                  <mat-chip *ngIf="data.data.roleIdDisplay" class="role-chip">
                    <mat-icon matChipAvatar>admin_panel_settings</mat-icon>
                    {{ data.data.roleIdDisplay }}
                  </mat-chip>
                </div>
              </div>
            </div>

            <div class="header-icon-title" *ngIf="!config.title.includes('User')">
              <mat-icon *ngIf="config.icon" class="header-icon icon-primary">
                {{ config.icon }}
              </mat-icon>
              <div class="title-section">
                <h2 class="popup-title">{{ config.title }}</h2>
                <p *ngIf="config.subtitle" class="popup-subtitle">{{ config.subtitle }}</p>
              </div>
            </div>

            <button mat-icon-button class="close-button"
                    (click)="onClose()"
                    matTooltip="Close">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>

        <!-- View Content -->
        <div class="popup-content view-content" [@slideInOut]>
          
          <!-- Field Display Grid -->
          <div class="view-grid" [ngClass]="{
            'grid-1-column': config.columns === 1,
            'grid-2-column': config.columns === 2,
            'grid-3-column': config.columns === 3,
            'grid-4-column': config.columns === 4,
            'compact': config.compactMode
          }">
            
            <ng-container *ngFor="let field of config.fields; trackBy: trackByField">
              <!-- ðŸ†• DIVIDER FIELD (OUTSIDE field-display) -->
              <div *ngIf="field.type === 'divider' && shouldShowField(field)" 
                   class="view-field divider-view-field"
                   [ngClass]="{
                     'span-4': true,
                     'break-after': field.breakAfter
                   }"
                   [@fadeInOut]>
                <div class="divider-field view-divider">
                  <mat-divider></mat-divider>
                  <span *ngIf="field.label" class="divider-label">{{ field.label }}</span>
                </div>
              </div>
              <div class="view-field" 
                   [ngClass]="{
                     'span-1': (field.colSpan === 1 || !field.colSpan) && field.type !== 'file',
                     'span-2': field.colSpan === 2 || field.type === 'file',
                     'span-3': field.colSpan === 3,
                     'span-4': field.colSpan === 4,
                     'break-after': field.breakAfter,
                     'file-field-view': field.type === 'file'
                   }"
                   [@fadeInOut]
                   *ngIf="shouldShowField(field) && field.type !== 'divider'">
                  
                <div class="field-display">
                  <div class="field-header">
                    <mat-icon *ngIf="field.icon" class="field-icon">{{ field.icon }}</mat-icon>
                    <label class="field-label">{{ field.label }}</label>
                  </div>
                  
                  <!-- ðŸ”¥ FILE FIELD (PRIORITY CHECK) -->
                  <ng-container *ngIf="field.type === 'file'; else nonFileField">
                    <div class="field-value file-field-value">

                      <!-- File Exists -->
                      <ng-container *ngIf="getFieldFileUrl(field.key) as fileUrl; else noFileInView">
                        <div class="file-view-container"
                             [ngClass]="getFileViewContainerClasses(field)">

                          <!-- Image Preview -->
                          <div *ngIf="isImageFile(fileUrl)" class="file-image-preview">
                            <img [src]="fileUrl" 
                                 [alt]="field.label"
                                 [style.width]="field.previewWidth || '100%'"
                                 [style.max-width]="isCompactFileField(field) ? '100%' : '500px'"
                                 [style.height]="field.previewHeight || 'auto'"
                                 [style.max-height]="isCompactFileField(field) ? '180px' : '400px'"
                                 class="preview-image"
                                 loading="lazy"
                                 (error)="onImageError($event)">
                          </div>
                        
                          <!-- Document Preview -->
                          <div *ngIf="!isImageFile(fileUrl)" class="file-document-preview">
                            <div class="document-icon-wrapper">
                              <mat-icon class="document-icon">{{ getFileIcon(fileUrl) }}</mat-icon>
                            </div>
                            <div class="document-info">
                              <span class="document-name" *ngIf="field.showFileName !== false">
                                {{ getFileName(fileUrl) }}
                              </span>
                              <span class="document-type" *ngIf="getFileExtension(fileUrl)">
                                {{ getFileExtension(fileUrl).toUpperCase() }} File
                              </span>
                            </div>
                          </div>
                        
                          <!-- Action Buttons -->
                          <div class="file-view-actions">
                            <button type="button" 
                                    mat-raised-button 
                                    color="primary"
                                    class="preview-btn"
                                    (click)="onFilePreview(fileUrl, getFileName(fileUrl))"
                                    matTooltip="Preview File">
                              <mat-icon>visibility</mat-icon>
                              <span>Preview</span>
                            </button>
                          
                            <button type="button" 
                                    mat-raised-button 
                                    *ngIf="field.downloadEnabled !== false"
                                    class="download-btn"
                                    (click)="onFileDownload(fileUrl, getFileName(fileUrl))"
                                    matTooltip="Download File">
                              <mat-icon>download</mat-icon>
                              <span>Download</span>
                            </button>
                          </div>
                        </div>
                      </ng-container>
                    
                      <!-- No File Template -->
                      <ng-template #noFileInView>
                        <div class="no-file-view"
                             [ngClass]="getFileViewContainerClasses(field)">
                          <mat-icon class="no-file-icon">insert_drive_file</mat-icon>
                          <span class="no-file-text">No file uploaded</span>
                        </div>
                      </ng-template>
                    
                    </div>
                  </ng-container>
                
                  <!-- ðŸ”¥ NON-FILE FIELDS -->
                  <ng-template #nonFileField>
                    <div class="field-value" 
                         [ngClass]="{
                           'value-text': field.type === 'text',
                           'value-textarea': field.type === 'textarea',
                           'value-date': field.type === 'date',
                           'value-select': field.type === 'select',
                           'value-checkbox': field.type === 'checkbox',
                           'value-country': field.key === 'country'
                         }">

                      <!-- ðŸ”¥ INFO FIELD - HANDLE SEPARATELY -->
                      <ng-container *ngIf="field.type === 'info'">
                        <div class="info-value-display" 
                             [class.depreciation-schedule-container]="field.key === 'depreciationScheduleDisplay'"
                             [innerHTML]="sanitizeHtml(field.value)"></div>

                        <div *ngIf="field.helperText && field.key !== 'depreciationScheduleDisplay'" 
                             class="info-helper-text">
                          {{ field.helperText }}
                        </div>
                      </ng-container>
                    
                      
                      <!-- Country Display -->
                      <div *ngIf="field.key === 'country' && getDisplayValue(field)" class="country-display-value">
                        <img [src]="getCountryFlagUrl(getCountryCodeFromName(getDisplayValue(field)))" 
                             [alt]="getDisplayValue(field) + ' flag'"
                             class="country-flag-inline"
                             loading="lazy"
                             onerror="this.style.display='none'">
                        <span class="country-name">{{ getDisplayValue(field) }}</span>
                      </div>
                      
                      <!-- Regular Text/Number/Date -->
                      <span class="formatted-value" 
                            *ngIf="field.type !== 'checkbox' && field.key !== 'country' && field.type !== 'email' && field.type !== 'info'">
                        {{ formatDisplayValue(field, getDisplayValue(field)) }}
                      </span>
                    
                      <!-- Email with Verification -->
                      <ng-container *ngIf="field.type === 'email'">
                        <span class="formatted-value">
                          {{ formatDisplayValue(field, getDisplayValue(field)) }}
                        </span>
                        
                        <div *ngIf="field.showEmailVerification" class="email-verification-status">
                          <mat-icon class="status-icon" 
                                    [ngClass]="data.data[field.emailVerificationKey || 'isEmailVerified'] ? 'verified' : 'not-verified'">
                            {{ data.data[field.emailVerificationKey || 'isEmailVerified'] ? 'verified' : 'pending' }}
                          </mat-icon>
                          <span class="status-text" 
                                [ngClass]="data.data[field.emailVerificationKey || 'isEmailVerified'] ? 'verified' : ''">
                            {{ data.data[field.emailVerificationKey || 'isEmailVerified'] ? 'Email Verified' : 'Email Not Verified' }}
                          </span>
                        </div>
                      </ng-container>
                      
                      <!-- Checkbox -->
                      <div *ngIf="field.type === 'checkbox'" class="checkbox-value">
                        <mat-icon class="status-icon" [class.active]="getDisplayValue(field)">
                          {{ getDisplayValue(field) ? 'check_circle' : 'radio_button_unchecked' }}
                        </mat-icon>
                        <span>{{ getDisplayValue(field) ? 'Yes' : 'No' }}</span>
                      </div>
                      
                      <!-- Country Not Specified -->
                      <span *ngIf="field.key === 'country' && !getDisplayValue(field)" class="formatted-value">
                        Not specified
                      </span>
                    </div>
                  </ng-template>
                
                </div>
              </div>
            </ng-container>
          </div>

          <!-- View Actions -->
          <div class="popup-actions view-actions" [@slideInOut]>
            <button mat-button (click)="onClose()">
              {{ config.closeButtonText || 'Close' }}
            </button>

            <button *ngIf="config.showEditButton" 
                    mat-raised-button color="primary" 
                    (click)="onEdit()">
              <mat-icon>edit</mat-icon>
              {{ config.editButtonText || 'Edit' }}
            </button>
          </div>

        </div>

      </div>
    </ng-container>
  </ng-container>

  <!-- CONFIRMATION TYPE POPUP -->
  <ng-container *ngIf="isConfirmType() && confirmConfig as config">
    
    <!-- Header -->
    <div class="popup-header" [@slideInOut]>
      <div class="header-content">
        <div class="header-icon-title">
          <mat-icon *ngIf="config.icon" 
                    class="header-icon"
                    [class]="'icon-' + (config.iconColor || 'primary')">
            {{ config.icon }}
          </mat-icon>
          <h2 class="popup-title">{{ config.title }}</h2>
        </div>
        <button mat-icon-button class="close-button"
                (click)="onClose()"
                [disabled]="loading()"
                matTooltip="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <!-- Confirmation Content -->
    <div class="popup-content confirm-content" [@slideInOut]>
      <div class="confirm-message">
        <p class="primary-message">{{ config.message }}</p>
        <p *ngIf="config.details" class="details-message">{{ config.details }}</p>
      </div>
    </div>

    <!-- Confirmation Actions -->
    <div class="popup-actions confirm-actions" [@slideInOut]>
      <button mat-button type="button" 
              (click)="onCancel()"
              [disabled]="loading()"
              class="cancel-button">
        {{ config.cancelButtonText || 'Cancel' }}
      </button>
      
      <button mat-raised-button 
              [color]="config.confirmButtonColor || 'primary'"
              (click)="onConfirm()"
              [disabled]="loading()"
              class="confirm-button">
        <mat-spinner *ngIf="loading()" diameter="20" class="button-spinner"></mat-spinner>
        <span *ngIf="!loading()">{{ config.confirmButtonText || 'Confirm' }}</span>
      </button>
    </div>

  </ng-container>

</div>